<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>SparkInfer å¯åŠ¨å™¨</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        /* å¢åŠ  select çš„æ ·å¼ */
        select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; background: white; }
        /* å…¶ä»–æ ·å¼ä¿æŒä¸å˜ */
        body { font-family: 'Segoe UI', sans-serif; background-color: #f4f4f9; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .card { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 400px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; }
        input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        button { width: 100%; padding: 10px; background-color: #42b983; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; margin-top: 10px; }
        button:hover { background-color: #3aa876; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        .status { margin-top: 15px; text-align: center; color: #666; font-size: 0.9em; }
        .logo { text-align: center; margin-bottom: 20px; font-size: 24px; font-weight: bold; color: #2c3e50; }
    </style>
</head>
<body>
    <div id="app" class="card">
        <div class="logo">ğŸš€ SparkInfer Launcher</div>
        
        <div class="form-group">
            <label>ä¸»æ¨¡å‹ (Model)</label>
            <select v-model="form.model">
                <option value="" disabled>è¯·é€‰æ‹©æ¨¡å‹æ–‡ä»¶ (.gguf)</option>
                <option v-for="file in files" :key="file" :value="file">{{ file }}</option>
            </select>
        </div>

        <div class="form-group">
            <label>åˆ†ç‰‡æ–‡ä»¶ (Model Split)</label>
            <select v-model="form.model_split">
                <option value="" disabled>è¯·é€‰æ‹©åˆ†ç‰‡æ–‡ä»¶ (.gguf)</option>
                <option v-for="file in files" :key="file" :value="file">{{ file }}</option>
            </select>
        </div>

        <div class="form-group">
            <label>æ˜¾å­˜é¢„ç®— (VRAM Budget)</label>
            <input v-model.number="form.vram_budget" type="number">
        </div>

        <div class="form-group">
            <label>çº¿ç¨‹æ•° (Threads)</label>
            <input v-model.number="form.threads" type="number">
        </div>

        <button @click="launchServer" :disabled="loading">
            {{ loading ? 'å¯åŠ¨ä¸­...' : 'å¯åŠ¨æ¨ç†æœåŠ¡' }}
        </button>

        <div class="status" v-if="message">{{ message }}</div>
    </div>

    <script>
        const { createApp, reactive, ref, onMounted } = Vue;

        createApp({
            setup() {
                const loading = ref(false);
                const message = ref('');
                const files = ref([]); // å­˜å‚¨æ–‡ä»¶åˆ—è¡¨

                const form = reactive({
                    model: '', 
                    model_split: '',
                    vram_budget: 6,
                    threads: 12
                });

                // ç»„ä»¶æŒ‚è½½æ—¶è·å–æ–‡ä»¶åˆ—è¡¨
                onMounted(async () => {
                    try {
                        const res = await fetch('/api/files');
                        const data = await res.json();
                        files.value = data.files || [];
                        
                        // ç®€å•çš„è‡ªåŠ¨åŒ¹é…é€»è¾‘ï¼ˆå¯é€‰ï¼‰
                        // å¦‚æœæœ‰æ–‡ä»¶åŒ…å« "split"ï¼Œè‡ªåŠ¨é€‰ä¸º split
                        const splitFile = files.value.find(f => f.includes('split'));
                        if (splitFile) form.model_split = splitFile;
                        
                        // é€‰ç¬¬ä¸€ä¸ªä¸æ˜¯ split çš„åš main model
                        const mainFile = files.value.find(f => !f.includes('split'));
                        if (mainFile) form.model = mainFile;

                    } catch (e) {
                        message.value = 'æ— æ³•è·å–æ¨¡å‹æ–‡ä»¶åˆ—è¡¨';
                    }
                });

                const launchServer = async () => {
                    loading.value = true;
                    message.value = 'æ­£åœ¨å¯åŠ¨...';
                    try {
                        const res = await fetch('/start-server', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(form)
                        });
                        const data = await res.json();
                        if (res.ok) {
                            message.value = 'å¯åŠ¨æˆåŠŸï¼Œè·³è½¬ä¸­...';
                            setTimeout(() => window.location.href = data.targetUrl, 2000);
                        } else {
                            message.value = 'é”™è¯¯: ' + data.message;
                            loading.value = false;
                        }
                    } catch (err) {
                        message.value = 'è¯·æ±‚å¤±è´¥';
                        loading.value = false;
                    }
                };

                return { form, launchServer, loading, message, files };
            }
        }).mount('#app');
    </script>
</body>
</html>